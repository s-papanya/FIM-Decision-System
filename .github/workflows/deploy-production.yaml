name: Deploy Vector & Update Env

on:
  push:
    branches: [ "main" ] # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ code ‡πÉ‡∏ô branch main
    paths:
      - 'config/vector/**'   # ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ Config Vector
      - '.github/workflows/**'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üöö Copy Vector Config to Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "configs/vector/vector.yaml"
        target: "/tmp/" # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà tmp ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á)

    - name: üõ†Ô∏è Apply Config & Update Env
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |

          echo "üîê Updating Environment Variables..."

          # ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î Systemd ‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà
          sudo systemctl daemon-reload

          # ---------------------------------------------------
          # ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: Validate ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏ü‡∏•‡πå Config (Vector.yaml)
          # ---------------------------------------------------
          echo "üîç Validating new config..."
          
          # ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å tmp ‡∏°‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå home ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ user ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô validate
          mv /tmp/configs/vector/vector.yaml ./vector-new.yaml

          echo "‚úÖ Config OK. Applying changes..."
          
          # Backup ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏û‡∏•‡∏≤‡∏î)
          sudo cp /etc/vector/vector.yaml /etc/vector/vector.yaml.bak

          # ‡πÄ‡∏≠‡∏≤‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡∏ó‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
          sudo mv ./vector-new.yaml /etc/vector/vector.yaml
          
          # ---------------------------------------------------
          # ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: Restart Service
          # ---------------------------------------------------
          sudo systemctl restart vector
          
          # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
          sudo systemctl status vector --no-pager
          echo "üöÄ Deployment Complete!"